var TokenType;(function(b){b[b.Text=0]="Text";b[b.StartTag=1]="StartTag";b[b.EndTag=2]="EndTag"})(TokenType||(TokenType={}));
var Token=function(){function b(a,b,c){this.content=a;this.tokenType=b;this.tagAttributes=c}b.prototype.toString=function(){return this.content+" ("+TokenType[this.tokenType]+")"};b.prototype.equals=function(a){return this.tokenType==a.tokenType&&this.content==a.content};return b}(),Tokenizer=function(){function b(a){this.bbTags=a}b.prototype.isStartTag=function(a){return"["==a[0]&&"]"==a[a.length-1]};b.prototype.isEndTag=function(a){return"["==a[0]&&"/"==a[1]&&"]"==a[a.length-1]};b.prototype.createTextToken=
function(a){return new Token(a,0)};b.prototype.createEndTagToken=function(a,b,c){a=a.substr(b,b+c-1-b+1);a=a.substr(2,a.length-3);return new Token(a,2)};b.prototype.createSimpleEndTagToken=function(a){a=a.substr(2,a.length-3);return new Token(a,2)};b.prototype.createStartTagToken=function(a){for(var b=a=a.substr(1,a.length-2),c=[],d=!1,e=0,m="",f=!1,g=0,h=!1,p=!1,l=0;l<a.length;){var n=a[l];d?(f||h||" "!=n||(e=l+1,f=!0),f&&"="==n&&(m=a.substr(e,l-e),h=!0,f=p=!1),h&&'"'==n&&(p?(n=a.substr(g,l-g),h=
!1,void 0==c[m]&&(c[m]=n)):(p=!0,g=l+1))):(" "==n&&(b=a.substr(0,l),d=!0,e=l+1,f=!0),"="==n&&(m=b=a.substr(0,l),h=d=!0,f=p=!1));l++}return new Token(b,1,c)};b.prototype.tokenizeString=function(a){a=this.getTokens(a);for(var b in a){var c=a[b];void 0==this.bbTags[c.content]&&(1==c.tokenType&&(c.content="["+c.content+"]",c.tokenType=0),2==c.tokenType&&(c.content="[/"+c.content+"]",c.tokenType=0))}return a};b.prototype.getTokens=function(a){for(var b=[],c="",d=0,e=0,m=!1,f=!1,g="";e<a.length;){c+=a[e];
if(f){var h="[/"+g+"]";endsWith(c,h)&&(c=c.substr(0,c.length-(3+g.length)),b.push(this.createTextToken(c)),b.push(this.createSimpleEndTagToken(h)),c="",f=!1,e==a.length-1&&(m=!0))}else"["==a[e]&&(1<c.length&&(c=c.substr(0,c.length-1),""!=c&&b.push(this.createTextToken(c))),c="[",d=e),3<=c.length&&(this.isEndTag(c)?(b.push(this.createEndTagToken(a,d,c.length)),c="",e==a.length-1&&(m=!0)):this.isStartTag(c)&&!f&&(h=this.createStartTagToken(c),b.push(h),c="",g=h.content,h=this.bbTags[h.content],void 0!=
h&&h.noNesting&&(f=!0)));e++}m||(c=c.substr(0,c.length),""!=c&&b.push(this.createTextToken(c)));return b};return b}();var TreeType;(function(b){b[b.Root=0]="Root";b[b.Text=1]="Text";b[b.Tag=2]="Tag"})(TreeType||(TreeType={}));
var BBCodeParseTree=function(){function b(a,b,c,d){this.treeType=a;this.content=b;this.attributes=c;this.subTrees=d;this.subTrees=[]}b.prototype.isValid=function(){if(0==this.subTrees.length)return!0;for(var a in this.subTrees){var b=this.subTrees[a];if(null==b||!b.isValid())return!1}return!0};b.prototype.toString=function(){return TreeType[this.treeType]+" - "+this.content};b.buildTree=function(a,k){var c=(new Tokenizer(k)).tokenizeString(a);return b.buildTreeFromTokens(new b(0,a),c.reverse())};
b.buildTreeFromTokens=function(a,k,c){"undefined"===typeof c&&(c="");if(null==a)return null;if(0==k.length)return a;var d=k.pop();0==d.tokenType&&a.subTrees.push(new b(1,d.content));if(1==d.tokenType){var e=d.content;a.subTrees.push(b.buildTreeFromTokens(new b(2,e,d.tagAttributes),k,e))}return 2==d.tokenType?(e=d.content,e==c?a:null):0==k.length&&""!=c?null:b.buildTreeFromTokens(a,k,c)};return b}();function endsWith(b,a){if(0==b.length||a.length>b.length)return!1;var k=b.substr(b.length-a.length,a.length);return a==k}function startsWith(b,a){if(0==b.length||a.length>b.length)return!1;var k=b.substr(0,a.length);return a==k}var tagsToReplace={"&":"&amp;","<":"&lt;",">":"&gt;"};function escapeHTML(b){return b.replace(/[&<>]/g,function(a){return tagsToReplace[a]||a})}
var BBTag=function(){return function(b,a,k,c,d){this.tagName=b;this.insertLineBreaks=a;this.suppressLineBreaks=k;this.noNesting=c;this.markupGenerator=d;void 0==d&&(this.markupGenerator=function(a,b,c){return"<"+a.tagName+">"+b+"</"+a.tagName+">"})}}(),BBCodeParser=function(){function b(a){this.bbTags=a}b.prototype.parseString=function(a){var b=BBCodeParseTree.buildTree(a,this.bbTags);return b.isValid()?this.treeToHtml(b.subTrees,!0):a};b.prototype.treeToHtml=function(a,b){var c=this,d="",e=!1;a.forEach(function(a){if(a.treeType==
TreeType.Text)a=a.content,a=escapeHTML(a),b&&!e&&(a=a.replace(/(\r\n|\n|\r)/gm,"<br>"),e=!1),d+=a;else{var f=c.bbTags[a.content],g=c.treeToHtml(a.subTrees,f.InsertLineBreaks);d+=f.markupGenerator(f,g,a.attributes);e=f.suppressLineBreaks}});return d};return b}(),BBCodeParserSettings=function(){function b(){}b.defaultTags=function(a){var b=[],c={},d=[];void 0==a?(b.push("text"),b.push("java"),b.push("javascript"),b.push("matlab"),b.push("csharp"),b.push("scala"),b.push("php"),b.push("cpp"),b.push("haskell")):
b=a;c={js:"javascript"};d.b=new BBTag("b",!0,!1,!1);d.i=new BBTag("i",!0,!1,!1);d.u=new BBTag("u",!0,!1,!1);d.math=new BBTag("math",!1,!1,!0,function(a,b,c){return"`"+b+"`"});d.latex=new BBTag("latex",!0,!1,!0,function(a,b,c){return b});d.code=new BBTag("code",!1,!0,!0,function(a,d,f){d=d.replace(/^(\r\n|\n|\r)/,"");d=d.replace(/(\r\n|\n|\r)$/,"");if(void 0!=f.lang){var g=f.lang.toLowerCase();void 0!=c[g]&&(g=c[g]);b.some(function(a){return a==g})||(g="text");return'<highlightCode class="language-'+
escapeHTML(g)+'">'+d+"</highlightCode>"}return'<highlightCode class="language-text">'+d+"</highlightCode>"});d.text=new BBTag("text",!0,!1,!0,function(a,b,c){return b});d.img=new BBTag("img",!0,!1,!1,function(a,b,c){return'<img src="'+b+'" />'});d.url=new BBTag("url",!0,!1,!1,function(a,b,c){a=b;void 0!=c.url&&(a=escapeHTML(a));startsWith(a,"http://")||startsWith(a,"https://")||(a="http://"+a);return'<a href="'+a+'" target="_blank">'+b+"</a>"});return d};return b}();
